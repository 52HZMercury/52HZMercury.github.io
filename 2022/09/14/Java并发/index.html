

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/moon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mercury">
  <meta name="keywords" content="">
  
    <meta name="description" content="面试的常青树">
<meta property="og:type" content="article">
<meta property="og:title" content="Java并发">
<meta property="og:url" content="http://example.com/2022/09/14/Java%E5%B9%B6%E5%8F%91/index.html">
<meta property="og:site_name" content="Mercury&#39;s blog">
<meta property="og:description" content="面试的常青树">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.mercuryblog.site/img/1e4c16.9.png">
<meta property="article:published_time" content="2022-09-14T12:12:46.000Z">
<meta property="article:modified_time" content="2022-10-18T03:28:42.958Z">
<meta property="article:author" content="Mercury">
<meta property="article:tag" content="Java并发">
<meta property="article:tag" content="JUC">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img.mercuryblog.site/img/1e4c16.9.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Java并发 - Mercury&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":90,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/newloading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Mercury</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/Post%20Page.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Java并发"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-09-14 20:12" pubdate>
          2022年9月14日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          43k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          135 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Java并发</h1>
            
            <div class="markdown-body">
              
              <div class = "note note-success">
    <p>前言:<p>
    <ul> 
      <p>根据狂神说的视频以及《深入浅出Java多线程》整理出该笔记</p>
    </ul>
</div>



<h1 id="JUC"><a href="#JUC" class="headerlink" title="JUC"></a>JUC</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>JUC并发编程就是多线程的进阶版，主要包含三个类java.util.concurrent、 java.util.concurrent.automic、 java.util.concurrent.locks</p>
<h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><h3 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h3><p>进程就是<strong>应用程序在内存中分配的空间，也就是正在运行的程序</strong>，各个进程之间互不干扰。同时进程保存着程序每一个时刻运行的状态。</p>
<p><strong>一个线程执行一个子任务，这样一个进程就包含了多个线程，每个线程负责一个单独的子任务。</strong>总之，进程和线程的提出极大的提高了操作系统的性能。<strong>进程让操作系统的并发性成为了可能，而线程让进程的内部并发成为了可能。</strong></p>
<p>当然区别还是有的，他们本质的区别就是<strong>是否单独占有内存地址空间及其它系统资源（比如I/O）</strong>，另外一个重要区别是，<strong>进程是操作系统进行资源分配的基本单位，而线程是操作系统进行调度的基本单位</strong>，即CPU分配时间的单位 。</p>
<h3 id="线程的几个状态"><a href="#线程的几个状态" class="headerlink" title="线程的几个状态"></a>线程的几个状态</h3><ul>
<li><p>new 新建 </p>
</li>
<li><p>runnable 运行 </p>
</li>
<li><p>blocked 阻塞 </p>
</li>
<li><p>waiting 等待 </p>
</li>
<li><p>timed_waiting 超时等待 </p>
</li>
<li><p>terminated终止</p>
</li>
</ul>
<h3 id="wait-sleep区别"><a href="#wait-sleep区别" class="headerlink" title="wait/sleep区别"></a>wait/sleep区别</h3><ul>
<li><p>wait 会释放锁   sleep 不会释放锁</p>
</li>
<li><p>使用的范围不同  wait必须在同步代码块中 sleep可以任何地方使用</p>
</li>
<li><p>wait 不需要捕获异常   sleep则需要</p>
</li>
</ul>
<h3 id="Synchronzied-和Lock区别"><a href="#Synchronzied-和Lock区别" class="headerlink" title="Synchronzied 和Lock区别"></a>Synchronzied 和Lock区别</h3><ul>
<li><p>Synchronized 内置的Java关键字 Lock是一个Java类</p>
</li>
<li><p>S无法判断锁的状态 Lock可以判断是否获取到了锁</p>
</li>
<li><p>S会自动释放锁 Lock必须手动释放 如果不释放就会死锁</p>
</li>
<li><p>S 线程1 （获得锁）线程2 （等待），lock锁下的线程就不一定一直等</p>
</li>
<li><p>S可重入锁 不可以中断，非公平，Lock 可重入锁</p>
</li>
<li><p>S适合锁少量的代码同步问题 Lock适合锁大量的代码同步问题</p>
</li>
</ul>
<h2 id="虚假唤醒问题"><a href="#虚假唤醒问题" class="headerlink" title="虚假唤醒问题"></a>虚假唤醒问题</h2><p>先来看看synchronized下的生产者和消费者问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        data data = <span class="hljs-keyword">new</span> data();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    data.increment();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;A&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    data.decrement();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;B&quot;</span>).start();<br>    &#125;<br><br><br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">data</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//+1</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-keyword">if</span>(number!=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//等待</span><br>            <span class="hljs-keyword">this</span>.wait();<br>        &#125;<br>        number++;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;=&gt;&quot;</span>+number);<br>        <span class="hljs-comment">//通知其他线程</span><br>        <span class="hljs-keyword">this</span>.notifyAll();<br>    &#125;<br><br>    <span class="hljs-comment">//-1</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-keyword">if</span>(number==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">this</span>.wait();<br>        &#125;<br>        number--;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;=&gt;&quot;</span>+number);<br>        <span class="hljs-keyword">this</span>.notifyAll();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>若不是两个线程，而是多个线程，就会出现以下的问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java">A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>A=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>C=&gt;<span class="hljs-number">1</span><br>A=&gt;<span class="hljs-number">2</span><br>C=&gt;<span class="hljs-number">3</span><br>B=&gt;<span class="hljs-number">2</span><br>B=&gt;<span class="hljs-number">1</span><br>B=&gt;<span class="hljs-number">0</span><br>C=&gt;<span class="hljs-number">1</span><br>A=&gt;<span class="hljs-number">2</span><br>C=&gt;<span class="hljs-number">3</span><br>A=&gt;<span class="hljs-number">4</span><br>C=&gt;<span class="hljs-number">5</span><br>D=&gt;<span class="hljs-number">4</span><br>D=&gt;<span class="hljs-number">3</span><br>C=&gt;<span class="hljs-number">4</span><br>D=&gt;<span class="hljs-number">3</span><br>D=&gt;<span class="hljs-number">2</span><br>D=&gt;<span class="hljs-number">1</span><br>D=&gt;<span class="hljs-number">0</span><br>C=&gt;<span class="hljs-number">1</span><br>D=&gt;<span class="hljs-number">0</span><br>C=&gt;<span class="hljs-number">1</span><br>D=&gt;<span class="hljs-number">0</span><br>C=&gt;<span class="hljs-number">1</span><br>D=&gt;<span class="hljs-number">0</span><br>C=&gt;<span class="hljs-number">1</span><br>D=&gt;<span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure>



<p>问题分析</p>
<p>结果的出现原因是资源类的if判断，可能导致两个加的方法同时进来，造成的虚假唤醒问题 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>       <span class="hljs-keyword">while</span>(number!=<span class="hljs-number">0</span>)&#123;<br>           <span class="hljs-comment">//这里改成while  像自旋锁</span><br>           <span class="hljs-comment">//等待</span><br>           <span class="hljs-keyword">this</span>.wait();<br>       &#125;<br>       number++;<br>       System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;=&gt;&quot;</span>+number);<br>       <span class="hljs-comment">//通知其他线程</span><br>       <span class="hljs-keyword">this</span>.notifyAll();<br>   &#125;<br><br></code></pre></td></tr></table></figure>







<h2 id="lock锁下的生产者消费者问题"><a href="#lock锁下的生产者消费者问题" class="headerlink" title="lock锁下的生产者消费者问题"></a>lock锁下的生产者消费者问题</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> PC;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@program</span>: JUCDemo1</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>:</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: Mr.Like</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2022-09-30 18:59</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        data2 data = <span class="hljs-keyword">new</span> data2();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    data.increment();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;A&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    data.decrement();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;B&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    data.increment();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;C&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    data.decrement();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;D&quot;</span>).start();<br>    &#125;<br><br>&#125;<br><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">data2</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//使用lock 锁</span><br>    Lock lock =  <span class="hljs-keyword">new</span> ReentrantLock();<br>    Condition condition =  lock.newCondition();<br><br><br>    <span class="hljs-comment">//+1</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        lock.lock();<br>        <span class="hljs-comment">//ctrl+alt+t  快速环绕</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span>(number!=<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-comment">//等待</span><br>                condition.await();<br>            &#125;<br>            number++;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;=&gt;&quot;</span>+number);<br>            condition.signalAll();<span class="hljs-comment">//通知全部线程</span><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<span class="hljs-comment">//释放，防止死锁</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//-1</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span>(number==<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-comment">//等待</span><br>                condition.await();<br>            &#125;<br>            number--;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;=&gt;&quot;</span>+number);<br>            condition.signalAll();<span class="hljs-comment">//通知全部线程</span><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<span class="hljs-comment">//释放，防止死锁</span><br>        &#125;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="八锁问题"><a href="#八锁问题" class="headerlink" title="八锁问题"></a>八锁问题</h2><p>资源类phone可以发短信和打电话</p>
<p>1.创建一个Phone实例多线程调用两个方法，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone = <span class="hljs-keyword">new</span> phone();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone.call();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br>发短信<br>打电话<br><br></code></pre></td></tr></table></figure>

<p>分析：synchronized关键字是对对象上锁，谁先拿到锁，谁就先执行</p>
<p>2.创建一个Phone实例多线程调用两个方法，其中第一个线程调用的方法中加延迟，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone = <span class="hljs-keyword">new</span> phone();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone.call();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">4</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br>发短信<br>打电话<br><br></code></pre></td></tr></table></figure>

<p>分析：原理同上，谁先拿到锁，谁先执行</p>
<p>3.创建一个Phone实例多线程调用两个方法，其中一个是普通方法，而且该线程位置靠后，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo3</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone = <span class="hljs-keyword">new</span> phone();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone.watchvideo();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">4</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">watchvideo</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;看视频&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br>看视频<br>发短信<br></code></pre></td></tr></table></figure>

<p>分析：<code>watchvideo()</code>为普通方法，当然是不受锁的影响，因为 <code>sendMessage()</code>方法体 中有延迟语句，因此会后输出，其实 抛去延迟来说，两个输出结果为不一定</p>
<p>4.创建两个Phone实例多线程调用两个方法，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo4</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone1 = <span class="hljs-keyword">new</span> phone();<br>        phone phone2 = <span class="hljs-keyword">new</span> phone();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone1.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone2.call();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">4</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//输出</span><br>打电话<br>发短信<br></code></pre></td></tr></table></figure>

<p>分析：由于是两个对象，因此锁对象之间没有干扰，因为延时，所以打电话先输出，而且可以证明锁住的是实例对象，多个之间并不干扰</p>
<p>5.创建一个Phone实例多线程调用两个方法，两个方法都有static修饰，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone1 = <span class="hljs-keyword">new</span> phone();<br>       <span class="hljs-comment">// phone phone2 = new phone();</span><br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone1.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone1.call();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">4</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//输出</span><br>发短信<br>打电话<br></code></pre></td></tr></table></figure>

<p>分析：发短信 在前面的原因是 synchronized 加 静态方法 锁的是 Class ，<code>Phone.Class</code>只有单个。因此第二个线程需要 等待第一个线程释放Class锁才能执行。</p>
<p>6.创建两个Phone实例多线程调用两个方法，两个方法都有static修饰，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone1 = <span class="hljs-keyword">new</span> phone();<br>        phone phone2 = <span class="hljs-keyword">new</span> phone();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone1.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone2.call();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">4</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//输出</span><br>发短信<br>打电话<br></code></pre></td></tr></table></figure>

<p>分析：虽然是两个实例对象，但是锁住的是同一个phone.class，原理和5是一样的</p>
<p>7.创建一个Phone实例多线程调用两个方法，其中一个有static修饰，而且调用线程在前面，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo7</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone1 = <span class="hljs-keyword">new</span> phone();<br>        <span class="hljs-comment">//phone phone2 = new phone();</span><br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone1.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone1.call();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">4</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//输出</span><br>打电话<br>发短信<br></code></pre></td></tr></table></figure>

<p>分析：打电话 先输出的原因是 Phone7 实例 和 Phone7.Class 分别被锁，两个线程之间并无影响，因为线程延迟的原因。再次 证明 synchronized 锁的是 类实例即对象 、synchronized 加 静态方法 锁的是 Class</p>
<p>8.创建两个Phone实例多线程调用两个方法，其中一个有static修饰，而且调用线程在前面，问哪一个先执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo8</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phone phone1 = <span class="hljs-keyword">new</span> phone();<br>        phone phone2 = <span class="hljs-keyword">new</span> phone();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone1.sendMessage();<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//Java的延时方法</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            phone2.call();<br>        &#125;).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">phone</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">4</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;发短信&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打电话&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//输出</span><br>打电话<br>发短信<br></code></pre></td></tr></table></figure>

<p>分析：原理同7两个线程分别锁的是 Phone8.Class 和 Phone8实例，因为线程延迟，打电话 才会优先输出。</p>
<h2 id="集合的线程安全"><a href="#集合的线程安全" class="headerlink" title="集合的线程安全"></a>集合的线程安全</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ul>
<li>线程安全集合：多线程并发的基础上修改一个集合，不会发生ConcurrentModificationException并发修改异常</li>
<li>CopyOnWriteArrayList是线程安全的集合，ArrayList是线程不安全的集合，Vector是线程安全的集合</li>
</ul>
<h3 id="ArrayList的线程安全"><a href="#ArrayList的线程安全" class="headerlink" title="ArrayList的线程安全"></a>ArrayList的线程安全</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">demo1_arraylist</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                list.add(UUID.randomUUID().toString().substring(<span class="hljs-number">0</span>,<span class="hljs-number">5</span>));<br>                System.out.println(list);<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br>[<span class="hljs-keyword">null</span>, 0c293, 7509b]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b, <span class="hljs-number">50105</span>, a4b9f, cd3b1, 4d7bb, <span class="hljs-number">89969</span>, dd07a, de64e]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b, <span class="hljs-number">50105</span>, a4b9f, cd3b1, 4d7bb, <span class="hljs-number">89969</span>]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b, <span class="hljs-number">50105</span>, a4b9f, cd3b1]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b, <span class="hljs-number">50105</span>, a4b9f, cd3b1, 4d7bb]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b, <span class="hljs-number">50105</span>, a4b9f]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b, <span class="hljs-number">50105</span>]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b]<br>[<span class="hljs-keyword">null</span>, 0c293, 7509b]<br>Exception in thread <span class="hljs-string">&quot;8&quot;</span> java.util.ConcurrentModificationException<br>	at java.util.ArrayList$Itr.checkForComodification(ArrayList.java:<span class="hljs-number">911</span>)<br>	at java.util.ArrayList$Itr.next(ArrayList.java:<span class="hljs-number">861</span>)<br>	at java.util.AbstractCollection.toString(AbstractCollection.java:<span class="hljs-number">461</span>)<br>	at java.lang.String.valueOf(String.java:<span class="hljs-number">2994</span>)<br>	at java.io.PrintStream.println(PrintStream.java:<span class="hljs-number">821</span>)<br>	at listsecurity.demo1_arraylist.lambda$main$<span class="hljs-number">0</span>(demo1_arraylist.java:<span class="hljs-number">20</span>)<br>	at java.lang.Thread.run(Thread.java:<span class="hljs-number">748</span>)<br><br></code></pre></td></tr></table></figure>

<p>如何解决呢？</p>
<ul>
<li>使用Vector：查看Vector的add()方法，发现相比于ArrayList的add()方法前面加了synchronized修饰,因此是线程安全的</li>
<li>使用Collectiobns.synchronizedlist(new ArrayList<String>):Collections集合工具类提供一些列线程安全的集合构造方法。</li>
<li>使用 JUC包下的 CopyOnWriteArrayList集合:一种线程安全的集合，CopyOnWrite的意思是写入时复制，是一种计算机程序设计优化策略，解决多线程写入覆盖问题</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;String&gt; list = <span class="hljs-keyword">new</span> Vector&lt;&gt;();<br>List&lt;String&gt; list = Collections.synchronizedList(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;());<br>List&lt;String&gt; list = <span class="hljs-keyword">new</span> CopyOnWriteArrayList&lt;&gt;();<br><span class="hljs-comment">//这几个就是线程安全的</span><br></code></pre></td></tr></table></figure>

<h3 id="Set-Map集合的线程安全"><a href="#Set-Map集合的线程安全" class="headerlink" title="Set,Map集合的线程安全"></a>Set,Map集合的线程安全</h3><p>对比ArrayList，Set同样线程并不安全，可以通过上面类似的解决</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Set&lt;String&gt; set = Collections.synchronizedSet(<span class="hljs-keyword">new</span> HashSet&lt;&gt;());<br>Set&lt;String&gt; set = <span class="hljs-keyword">new</span> CopyOnWriteArraySet&lt;&gt;();<br></code></pre></td></tr></table></figure>



<p>实际上HashSet的底层是HashMap方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Constructs a new, empty set; the backing &lt;tt&gt;HashMap&lt;/tt&gt; instance has</span><br><span class="hljs-comment">     * default initial capacity (16) and load factor (0.75).</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HashSet</span><span class="hljs-params">()</span> </span>&#123;<br>        map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    &#125;<br><span class="hljs-comment">//源码中的构造方法</span><br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Adds the specified element to this set if it is not already present.</span><br><span class="hljs-comment">     * More formally, adds the specified element &lt;tt&gt;e&lt;/tt&gt; to this set if</span><br><span class="hljs-comment">     * this set contains no element &lt;tt&gt;e2&lt;/tt&gt; such that</span><br><span class="hljs-comment">     * &lt;tt&gt;(e==null&amp;nbsp;?&amp;nbsp;e2==null&amp;nbsp;:&amp;nbsp;e.equals(e2))&lt;/tt&gt;.</span><br><span class="hljs-comment">     * If this set already contains the element, the call leaves the set</span><br><span class="hljs-comment">     * unchanged and returns &lt;tt&gt;false&lt;/tt&gt;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e element to be added to this set</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &lt;tt&gt;true&lt;/tt&gt; if this set did not already contain the specified</span><br><span class="hljs-comment">     * element</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> map.put(e, PRESENT)==<span class="hljs-keyword">null</span>;<br>    &#125;<br><span class="hljs-comment">//add方法也是直接调用的</span><br></code></pre></td></tr></table></figure>

<p>因此Map也是不安全的，解决方法同样有两种</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String,String&gt; map = Collections.synchronizedMap(<span class="hljs-keyword">new</span> HashMap&lt;&gt;())<br>Map&lt;String,String&gt; map = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();<br></code></pre></td></tr></table></figure>

<h2 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h2><p>ReadWriteLock维护一对关联的locks ，一个用于只读操作，一个用于写入。 read lock可以由多个阅读器线程同时进行，只要没有作者。 write lock是独家的。简单理解就是 可以多个线程同时读，只能有一个线程同时写。</p>
<p>对于最初填充数据的集合，然后经常被修改的场合时使用读写锁的立项候选，但是对于数据的大部分时间被专门锁定，并且并发型增加很少，那么不建议使用读写锁，<strong>简单理解就是 经常被修改的读取的数据，建议使用读写锁，对于不长变动而且 并发很少的情况，不建议使用读写锁。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//使用读写锁，实现模拟缓存</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">demo1_rwl</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        MycacheReadWriteLock cache = <span class="hljs-keyword">new</span> MycacheReadWriteLock();<br><br>        <span class="hljs-comment">//四个线程写入缓存</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  temp = i;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                cache.save(temp + <span class="hljs-string">&quot;&quot;</span>,temp + <span class="hljs-string">&quot;&quot;</span>);<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br><br>        <span class="hljs-comment">//四个线程写入缓存</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>  temp = i;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                cache.get(temp + <span class="hljs-string">&quot;&quot;</span>);<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br><br><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//模拟缓存 加上读写锁</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MycacheReadWriteLock</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Map&lt;String,String&gt; cache  = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br>    <span class="hljs-comment">//读写锁对象</span><br>    ReentrantReadWriteLock reentrantReadWriteLock = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">(String key,String value)</span></span>&#123;<br><br>         <span class="hljs-comment">//加入写锁 保证只有一个线程来写</span><br>          reentrantReadWriteLock.writeLock().lock();<br><br><br>         <span class="hljs-keyword">try</span> &#123;<br>             System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;===&gt;开始写入数据&quot;</span>);<br>             cache.put(key,value);<br>             System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;===&gt;写入成功了&quot;</span>);<br>         &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>             e.printStackTrace();<br>         &#125; <span class="hljs-keyword">finally</span> &#123;<br>             reentrantReadWriteLock.writeLock().unlock();<br>         &#125;<br><br><br>     &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">(String key)</span></span>&#123;<br>        <span class="hljs-comment">//加上读锁，保证读的时候没有其他的线程在写</span><br>        reentrantReadWriteLock.readLock().lock();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;===&gt;开始获取数据&quot;</span>);<br>            cache.get(key);<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;===&gt;获取成功&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">//释放读锁</span><br>            reentrantReadWriteLock.readLock().unlock();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br><span class="hljs-number">0</span>===&gt;开始写入数据<br><span class="hljs-number">0</span>===&gt;写入成功了<br><span class="hljs-number">2</span>===&gt;开始写入数据<br><span class="hljs-number">2</span>===&gt;写入成功了<br><span class="hljs-number">3</span>===&gt;开始写入数据<br><span class="hljs-number">3</span>===&gt;写入成功了<br><span class="hljs-number">1</span>===&gt;开始写入数据<br><span class="hljs-number">1</span>===&gt;写入成功了<br><span class="hljs-number">1</span>===&gt;开始获取数据<br><span class="hljs-number">1</span>===&gt;获取成功<br><span class="hljs-number">0</span>===&gt;开始获取数据<br><span class="hljs-number">2</span>===&gt;开始获取数据<br><span class="hljs-number">3</span>===&gt;开始获取数据<br><span class="hljs-number">3</span>===&gt;获取成功<br><span class="hljs-number">2</span>===&gt;获取成功<br><span class="hljs-number">0</span>===&gt;获取成功<br></code></pre></td></tr></table></figure>



<h2 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h2><p><img src="https://img-blog.csdnimg.cn/20210712171515358.png" srcset="/img/newloading.gif" lazyload></p>
<p>BlockingQueue是Java util.concurrent包下重要的数据结构，区别于普通的队列，BlockingQueue提供了<strong>线程安全的队列访问方式</strong>，并发包下很多高级同步类的实现都是基于BlockingQueue实现的。阻塞队列简单的来说就是<strong>你只管往里面存、取就行，而不用担心多线程环境下存、取共享变量的线程安全问题。</strong></p>
<p>阻塞指两种状态</p>
<ul>
<li>入队：如果队列此时是满的，需要阻塞等待</li>
<li>取出：如果队列是空的，需要阻塞等待生产</li>
</ul>
<h3 id="阻塞队列的操作方法"><a href="#阻塞队列的操作方法" class="headerlink" title="阻塞队列的操作方法"></a>阻塞队列的操作方法</h3><p>提供了四组不同的方法用于插入，移除，检查元素</p>
<table>
<thead>
<tr>
<th align="center">方法\处理方式</th>
<th align="center">抛出异常</th>
<th align="center">返回特殊值</th>
<th align="center">一直阻塞</th>
<th align="center">超时退出</th>
</tr>
</thead>
<tbody><tr>
<td align="center">插入方法</td>
<td align="center">add(e)</td>
<td align="center">offer(e)</td>
<td align="center"><strong>put(e)</strong></td>
<td align="center">offer(e,time,unit)</td>
</tr>
<tr>
<td align="center">移除方法</td>
<td align="center">remove()</td>
<td align="center">poll()</td>
<td align="center"><strong>take()</strong></td>
<td align="center">poll(time,unit)</td>
</tr>
<tr>
<td align="center">检查方法</td>
<td align="center">element()</td>
<td align="center">peek()</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<ul>
<li>抛出异常：如果试图的操作无法立即执行，抛异常。当阻塞队列满时候，再往队列里插入元素，会抛出IllegalStateException(“Queue full”)异常。当队列为空时，从队列里获取元素时会抛出NoSuchElementException异常 。</li>
<li>返回特殊值：如果试图的操作无法立即执行，返回一个特殊值，通常是true / false。</li>
<li>一直阻塞：如果试图的操作无法立即执行，则一直阻塞或者响应中断。</li>
<li>超时退出：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功，通常是 true / false。</li>
</ul>
<p><strong>注意之处</strong></p>
<ul>
<li>不能往阻塞队列中插入null,会抛出空指针异常。</li>
<li>可以访问阻塞队列中的任意元素，调用remove(o)可以将队列之中的特定对象移除，但并不高效，尽量避免使用。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">demo1_blockingqueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-comment">//test1();</span><br>        <span class="hljs-comment">//test2();</span><br>        <span class="hljs-comment">//test3();</span><br>        test4();<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>&#123;<br>        ArrayBlockingQueue queue = <span class="hljs-keyword">new</span> ArrayBlockingQueue(<span class="hljs-number">3</span>);<br><br>        queue.add(<span class="hljs-string">&quot;william&quot;</span>);<br>        queue.add(<span class="hljs-string">&quot;will&quot;</span>);<br>        queue.add(<span class="hljs-string">&quot;iam&quot;</span>);<br><br>        System.out.println(queue);<br>        <span class="hljs-comment">//queue.add(&quot;队列已满，入队会抛异常&quot;); IllegalStateException</span><br><br>        System.out.println(queue.remove());<br>        <span class="hljs-comment">//获取队首元素</span><br>        System.out.println(queue.element());<br>        System.out.println(queue.remove());<br>        System.out.println(queue.remove());<br>       <span class="hljs-comment">//System.out.println(queue.element()); 队列为空的时候，获取队首元素抛异常 NoSuchElementException</span><br><br><br>        System.out.println(queue);<br><br>        <span class="hljs-comment">//System.out.println(queue.remove()); 队列已空，再次出队会抛异常 NoSuchElementException</span><br><br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>&#123;<br>        ArrayBlockingQueue queue = <span class="hljs-keyword">new</span> ArrayBlockingQueue(<span class="hljs-number">3</span>);<br><br>        queue.offer(<span class="hljs-string">&quot;william&quot;</span>);<br>        queue.offer(<span class="hljs-string">&quot;will&quot;</span>);<br>        queue.offer(<span class="hljs-string">&quot;iam&quot;</span>);<br><br>        System.out.println(queue.offer(<span class="hljs-string">&quot;队列已满，入队返回异常&quot;</span>));<br><br><br>        System.out.println(queue.poll());<br>        System.out.println(queue.poll());<br>        System.out.println(queue.poll());<br><br><br>        System.out.println(queue.poll()); <span class="hljs-comment">// 队列为空，出队返回null</span><br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        ArrayBlockingQueue queue = <span class="hljs-keyword">new</span> ArrayBlockingQueue(<span class="hljs-number">3</span>);<br><br><br>        queue.put(<span class="hljs-string">&quot;william&quot;</span>);<br>        queue.put(<span class="hljs-string">&quot;will&quot;</span>);<br>        queue.put(<span class="hljs-string">&quot;iam&quot;</span>);<br><br>        queue.put(<span class="hljs-string">&quot;队列已满，一直阻塞等待&quot;</span>);<br><br>        System.out.println(queue.take());<br>        System.out.println(queue.take());<br>        System.out.println(queue.take());<br><br>        System.out.println(queue.take());<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        ArrayBlockingQueue queue = <span class="hljs-keyword">new</span> ArrayBlockingQueue(<span class="hljs-number">3</span>);<br><br>        queue.put(<span class="hljs-string">&quot;william&quot;</span>);<br>        queue.put(<span class="hljs-string">&quot;will&quot;</span>);<br>        queue.put(<span class="hljs-string">&quot;iam&quot;</span>);<br><br><br>        queue.offer(<span class="hljs-string">&quot;队列已满，入队会超时等待&quot;</span>,<span class="hljs-number">3</span>, TimeUnit.SECONDS);<br><br><br>        System.out.println(queue.take());<br>        System.out.println(queue.take());<br>        System.out.println(queue.take());<br><br><br>        System.out.println(queue.poll(<span class="hljs-number">1</span>, TimeUnit.SECONDS)); <span class="hljs-comment">// 队列为空，超时等待，过时间自动结束</span><br>    &#125;<br>&#125;<br><span class="hljs-comment">//test1输出</span><br>[william, will, iam]<br>william<br>will<br>will<br>iam<br>[]<br><br><span class="hljs-comment">//test2输出</span><br><span class="hljs-keyword">false</span><br>william<br>will<br>iam<br><span class="hljs-keyword">null</span><br>    <br><span class="hljs-comment">//test3一直阻塞</span><br><br>    <br><span class="hljs-comment">//test4输出</span><br>william<br>will<br>iam<br><span class="hljs-keyword">null</span><br></code></pre></td></tr></table></figure>

<h3 id="同步队列"><a href="#同步队列" class="headerlink" title="同步队列"></a>同步队列</h3><p> <strong>SynchronousQueue</strong>这个队列比较特殊，<strong>没有任何内部容量</strong>，甚至连一个队列的容量都没有。并且每个 put 必须等待一个 take，反之亦然。</p>
<p>需要区别容量为1的ArrayBlockingQueue、LinkedBlockingQueue。</p>
<p>以下方法的返回值，可以帮助理解这个队列：</p>
<ul>
<li>iterator() 永远返回空，因为里面没有东西</li>
<li>peek() 永远返回null</li>
<li>put() 往queue放进去一个element以后就一直wait直到有其他thread进来把这个element取走。</li>
<li>offer() 往queue里放一个element后立即返回，如果碰巧这个element被另一个thread取走了，offer方法返回true，认为offer成功；否则返回false。</li>
<li>take() 取出并且remove掉queue里的element，取不到东西他会一直等。</li>
<li>poll() 取出并且remove掉queue里的element，只有到碰巧另外一个线程正在往queue里offer数据或者put数据的时候，该方法才会取到东西。否则立即返回null。</li>
<li>isEmpty() 永远返回true</li>
<li>remove()&amp;removeAll() 永远返回false</li>
</ul>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>池化技术就是事先准备好一些资源，有人需要用 久去那里拿，用完再还回去,</p>
<p>线程池的好处</p>
<ol>
<li>线程复用,可以控制最大并发数,管理线程</li>
<li>降低资源的消耗</li>
<li>提高响应的速度</li>
<li>方便管理</li>
</ol>
<p>使用Executors创建线程池</p>
<p>Executors创建的线程池实例常用的三个方法</p>
<ul>
<li>newSingleThreadExecutor()创建一个使用从无界队列运行的单个工作线程的执行程序。</li>
<li>newFixedThreadPool(int nThreads)创建一个线程池，该线程池重用固定数量的从共享无界队列中运行的线程。</li>
<li>newCachedThreadPool()创建一个根据需要创建新线程的线程池核心线程数为0，全部线程可回收，在可用时将重新使用以前构造的线程。</li>
<li>newScheduThreadPool()创建一个定时任务线程池</li>
<li>线程池关闭的方法pool.shutdown()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo1_ThreadPool</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ExecutorService pool1 = Executors.newSingleThreadExecutor();<br>        ExecutorService pool2 = Executors.newFixedThreadPool(<span class="hljs-number">6</span>);<br>        ExecutorService pool3 = Executors.newCachedThreadPool();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                pool1.execute(()-&gt;&#123;<br>                    System.out.println(Thread.currentThread().getName());<br>                &#125;);<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">//关闭线程池</span><br>            pool1.shutdown();<br>        &#125;<br><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                pool2.execute(()-&gt;&#123;<br>                    System.out.println(Thread.currentThread().getName());<br>                &#125;);<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">//关闭线程池</span><br>            pool1.shutdown();<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                pool3.execute(()-&gt;&#123;<br>                    System.out.println(Thread.currentThread().getName());<br>                &#125;);<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">//关闭线程池</span><br>            pool1.shutdown();<br>        &#125;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">2</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">3</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">4</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">3</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">5</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">6</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">2</span><br>pool-<span class="hljs-number">2</span>-thread-<span class="hljs-number">4</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">3</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">2</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">1</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">4</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">5</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">6</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">7</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">8</span><br>pool-<span class="hljs-number">3</span>-thread-<span class="hljs-number">3</span><br><br></code></pre></td></tr></table></figure>

<p>查看源码发现其实他们底层都是ThreadPoolExecutor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Creates an Executor that uses a single worker thread operating</span><br><span class="hljs-comment"> * off an unbounded queue, and uses the provided ThreadFactory to</span><br><span class="hljs-comment"> * create a new thread when needed. Unlike the otherwise</span><br><span class="hljs-comment"> * equivalent &#123;<span class="hljs-doctag">@code</span> newFixedThreadPool(1, threadFactory)&#125; the</span><br><span class="hljs-comment"> * returned executor is guaranteed not to be reconfigurable to use</span><br><span class="hljs-comment"> * additional threads.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> threadFactory the factory to use when creating new</span><br><span class="hljs-comment"> * threads</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the newly created single-threaded Executor</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> NullPointerException if threadFactory is null</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newSingleThreadExecutor</span><span class="hljs-params">(ThreadFactory threadFactory)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FinalizableDelegatedExecutorService<br>        (<span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>,<br>                                <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>                                <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),<br>                                threadFactory));<br>&#125;<br></code></pre></td></tr></table></figure>



<p>我们再来看一下ThreadPoolExecutor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-keyword">int</span> maximumPoolSize,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-keyword">long</span> keepAliveTime,</span></span><br><span class="hljs-params"><span class="hljs-function">                             TimeUnit unit,</span></span><br><span class="hljs-params"><span class="hljs-function">                             BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="hljs-params"><span class="hljs-function">                             ThreadFactory threadFactory)</span> </span>&#123;<br>       <span class="hljs-keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,<br>            threadFactory, defaultHandler);<br>   &#125;<br><br></code></pre></td></tr></table></figure>

<p>七大参数</p>
<p>核心线程数 ：@param corePoolSize 池中要保留的线程数，即使它们处于空闲状态，除非设置了 {@code allowCoreThreadTimeOut}</p>
<p>最大线程数：@param maximumPoolSize 池中允许的最大线程数</p>
<p>空闲存活时间：@param keepAliveTime 当线程数较大时与核心相比，这是多余空闲线程在终止之前等待新任务的最长时间。</p>
<p>超时单位：@param unit {@code keepAliveTime} 参数的时间单位</p>
<p>阻塞队列： @param workQueue 用于在执行任务之前保存任务的队列。该队列将仅保存由 {@code execute} 方法提交的 {@code Runnable} 任务。</p>
<p>线程工厂 ：@param threadFactory 执行程序创建新线程时使用的工厂</p>
<p>拒接策略：@param handler 执行被阻塞时使用的处理程序，因为达到了线程边界和队列容量 @throws IllegalArgumentException 如果以下情况之一成立：<br>{@code corePoolSize &lt; 0}<br>{@code keepAliveTime &lt; 0}<br>{@code maximumPoolSize &lt;= 0}<br>{@code maximumPoolSize &lt; corePoolSize}<br>@throws NullPointerException if {@code workQueue} 或 {@code threadFactory}或 {@code handler} 为空</p>
<h3 id="四种拒绝策略"><a href="#四种拒绝策略" class="headerlink" title="四种拒绝策略"></a>四种拒绝策略</h3><p>RejectedExecutionHandler 是拒绝策略的接口，有四个实现类</p>
<ul>
<li>AbortPolicy : 默认拒绝策略，抛出异常</li>
<li>DiscardPolicy：不会抛出异常，会丢掉任务</li>
<li>DiscardOldestPolicy：不会抛出异常，会和最早的线程尝试竞争资源，竞争不一定会成功，失败就丢调任务</li>
<li>CallerRunsPolicy：从哪个线程来的，哪个线程处理，即main线程处理</li>
</ul>
<p>最大线程数可以通过两种方式设置</p>
<ul>
<li><p>CPU密集型  和本机核心数保持一致，可以保证CPU的效率最高</p>
</li>
<li><p>IO密集型 根据程序中大型IO耗时线程，保证大于等于</p>
</li>
</ul>
<h2 id="四大函数式接口"><a href="#四大函数式接口" class="headerlink" title="四大函数式接口"></a>四大函数式接口</h2><p>都可以使用lamda表达式简化，函数式接口 只有一个方法的接口</p>
<p><code>java.util.Function</code> 包下的 有基本的四大函数式接口</p>
<ul>
<li><p>Function 函数式接口</p>
</li>
<li><p>Predicate 断定型接口</p>
</li>
<li><p>Consumer 消费型接口  只有输入没有返回值</p>
</li>
<li><p>Supplier 供给型接口 只有输出没有参数</p>
</li>
</ul>
<h3 id="Function接口"><a href="#Function接口" class="headerlink" title="Function接口"></a>Function接口</h3><p>apply方法接受一个参数t，返回一个参数R</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Represents a function that accepts one argument and produces a result.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;This is a &lt;a href=&quot;package-summary.html&quot;&gt;functional interface&lt;/a&gt;</span><br><span class="hljs-comment"> * whose functional method is &#123;<span class="hljs-doctag">@link</span> #apply(Object)&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt; the type of the input to the function</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;R&gt; the type of the result of the function</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.8</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Function</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">R</span>&gt; </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Applies this function to the given argument.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> t the function argument</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the function result</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">R <span class="hljs-title">apply</span><span class="hljs-params">(T t)</span></span>;<br>    <br><br><span class="hljs-comment">//接收T R返回的是R T</span><br></code></pre></td></tr></table></figure>

<p>例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">demo1_function</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Function&lt;String, String&gt; function = <span class="hljs-keyword">new</span> Function&lt;String, String&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">apply</span><span class="hljs-params">(String s)</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> s;<br>            &#125;<br>        &#125;;<br><br>        Function function1 = (str)-&gt;&#123;<span class="hljs-keyword">return</span> str;&#125;;<br>        Function function2 = str-&gt;&#123;<span class="hljs-keyword">return</span> str;&#125;;<span class="hljs-comment">//当只有一个参数的时候 括号可以省略</span><br><br>        System.out.println(function.apply(<span class="hljs-string">&quot;niubi&quot;</span>));<br>        System.out.println(function1.apply(<span class="hljs-string">&quot;niubi&quot;</span>));<br>        System.out.println(function2.apply(<span class="hljs-string">&quot;niubi&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="Predicate接口"><a href="#Predicate接口" class="headerlink" title="Predicate接口"></a>Predicate接口</h3><p>断定型接口，根据传入的数据，只返回boolean值</p>
<p>can can 源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Represents a predicate (boolean-valued function) of one argument.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;This is a &lt;a href=&quot;package-summary.html&quot;&gt;functional interface&lt;/a&gt;</span><br><span class="hljs-comment"> * whose functional method is &#123;<span class="hljs-doctag">@link</span> #test(Object)&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt; the type of the input to the predicate</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.8</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Predicate</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Evaluates this predicate on the given argument.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> t the input argument</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if the input argument matches the predicate,</span><br><span class="hljs-comment">     * otherwise &#123;<span class="hljs-doctag">@code</span> false&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">test</span><span class="hljs-params">(T t)</span></span>;<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_predicate</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Predicate&lt;String&gt; predicate = <span class="hljs-keyword">new</span> Predicate&lt;String&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">test</span><span class="hljs-params">(String s)</span> </span>&#123;<br>                <span class="hljs-keyword">if</span>(!s.isEmpty())&#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br>        &#125;;<br><br>        Predicate&lt;String&gt; predicate1 = s -&gt; &#123;<br>            <span class="hljs-keyword">if</span>(!s.isEmpty())&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;;<br><br>        System.out.println(predicate.test(<span class="hljs-string">&quot;william&quot;</span>));<span class="hljs-comment">//true</span><br>        System.out.println(predicate1.test(<span class="hljs-string">&quot;william&quot;</span>));<span class="hljs-comment">//true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Consumer接口"><a href="#Consumer接口" class="headerlink" title="Consumer接口"></a>Consumer接口</h3><p>消费者型接口，只有输入参数，没有返回值</p>
<p>can can 源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Represents an operation that accepts a single input argument and returns no</span><br><span class="hljs-comment"> * result. Unlike most other functional interfaces, &#123;<span class="hljs-doctag">@code</span> Consumer&#125; is expected</span><br><span class="hljs-comment"> * to operate via side-effects.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;This is a &lt;a href=&quot;package-summary.html&quot;&gt;functional interface&lt;/a&gt;</span><br><span class="hljs-comment"> * whose functional method is &#123;<span class="hljs-doctag">@link</span> #accept(Object)&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt; the type of the input to the operation</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.8</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Consumer</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Performs this operation on the given argument.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> t the input argument</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">accept</span><span class="hljs-params">(T t)</span></span>;<br></code></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo3_consumer</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Consumer&lt;String&gt; consumer = <span class="hljs-keyword">new</span> Consumer&lt;String&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">accept</span><span class="hljs-params">(String s)</span> </span>&#123;<br>                System.out.println(<span class="hljs-string">&quot;一共消费了&quot;</span> + s + <span class="hljs-string">&quot;元&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        Consumer&lt;String&gt; consumer1 = (s)-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;一共消费了&quot;</span> + s + <span class="hljs-string">&quot;元&quot;</span>);<br>        &#125;;<br><br>        consumer.accept(<span class="hljs-string">&quot;20&quot;</span>);<span class="hljs-comment">//20</span><br>        consumer.accept(<span class="hljs-string">&quot;30&quot;</span>);<span class="hljs-comment">//30</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="Supplier接口"><a href="#Supplier接口" class="headerlink" title="Supplier接口"></a>Supplier接口</h3><p>没有输入参数，只有 返回值</p>
<p>can can 源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Represents a supplier of results.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;There is no requirement that a new or distinct result be returned each</span><br><span class="hljs-comment"> * time the supplier is invoked.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;This is a &lt;a href=&quot;package-summary.html&quot;&gt;functional interface&lt;/a&gt;</span><br><span class="hljs-comment"> * whose functional method is &#123;<span class="hljs-doctag">@link</span> #get()&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt; the type of results supplied by this supplier</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.8</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Supplier</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Gets a result.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a result</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">T <span class="hljs-title">get</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo4_supplier</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Supplier&lt;String&gt; supplier = <span class="hljs-keyword">new</span> Supplier&lt;String&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;niuBi&quot;</span>;<br>            &#125;<br>        &#125;;<br><br>        Supplier&lt;String&gt; supplier1 = ()-&gt;&#123;<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;niuBi&quot;</span>;&#125;;<br><br>        System.out.println(supplier.get());<span class="hljs-comment">//niuBi</span><br>        System.out.println(supplier1.get());<span class="hljs-comment">//niuBi</span><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="Stream流式计算"><a href="#Stream流式计算" class="headerlink" title="Stream流式计算"></a>Stream流式计算</h2><p>什么是Stream流式计算</p>
<ul>
<li>常用的集合是为了存储数集，而对于集合数据的一些处理（像筛选集合数据等）可以使用Stream流来处理</li>
<li>java.util.tream包下的Stream接口 支持顺序和并行聚合操作的一系列元素</li>
<li>Stream流可以结合四大函数式接口进行数据处理（方法的参数支持函数式接口）<br>使用</li>
</ul>
<p>集合.stream() 可以将集合对象 转为 流对象，调用流对象的一些方法进行数据操作<br>常用方法</p>
<ul>
<li>filter(Predicate&lt;? super T&gt; predicate) 返回由与此给定谓词匹配的此流的元素组成的流。</li>
<li>count() 返回此流中的元素数。</li>
<li>forEach(Consumer&lt;? super T&gt; action) 对此流的每个元素执行操作。</li>
<li>sorted(Comparator&lt;? super T&gt; comparator) 返回由该流的元素组成的流，根据提供的 Comparator进行排序。</li>
<li>map(Function&lt;? super T,? extends R&gt; mapper)返回由给定函数应用于此流的元素的结果组成的流。</li>
<li>sorted(Comparator&lt;? super T&gt; comparator)返回由该流的元素组成的流，根据提供的 Comparator进行排序。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo_stream</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        User user1 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;william1&quot;</span>, <span class="hljs-number">18</span>, <span class="hljs-number">10000</span>);<br>        User user2 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;william2&quot;</span>, <span class="hljs-number">19</span>, <span class="hljs-number">11000</span>);<br>        User user3 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;william3&quot;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">12000</span>);<br>        User user4 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;william4&quot;</span>, <span class="hljs-number">21</span>, <span class="hljs-number">13000</span>);<br>        User user5 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;william5&quot;</span>, <span class="hljs-number">22</span>, <span class="hljs-number">14000</span>);<br>        User user6 = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;william6&quot;</span>, <span class="hljs-number">23</span>, <span class="hljs-number">15000</span>);<br><br>        List&lt;User&gt; users = Arrays.asList(user1, user2, user3, user4, user5, user6);<br><br>        <span class="hljs-comment">//1. forEach</span><br>        users.stream().forEach((user)-&gt;&#123;<br>            System.out.println(user);<br>        &#125;);<br><br>        <span class="hljs-comment">//记得关闭stream</span><br>        users.stream().close();<br><br>        System.out.println(<span class="hljs-string">&quot;---------我是分割线--------&quot;</span>);<br><br>        <span class="hljs-comment">//2.filter predicate接口</span><br>        users.stream()<br>                .filter((user) -&gt; &#123;<span class="hljs-keyword">return</span> user.getSalary() &gt; <span class="hljs-number">12000</span>;&#125;)<br>                .filter((user) -&gt; &#123;<span class="hljs-keyword">return</span> user.getAge() &gt; <span class="hljs-number">20</span>;&#125;)<br>                .forEach((user)-&gt;&#123;<br>                    System.out.println(user);<br>                &#125;);<br><br>        users.stream().close();<br><br>        <span class="hljs-comment">//3.map 和 排序</span><br>        users.stream()<br>                .filter((user)-&gt; user.getSalary() &lt; <span class="hljs-number">20000</span>)<br>                .map((user)-&gt; user.getSalary() + <span class="hljs-number">2000</span>)<br>                .sorted((u1,u2)-&gt;&#123;<span class="hljs-keyword">return</span> u1.compareTo(u2);&#125;)<br>                .forEach((user)-&gt;&#123;<br>                    System.out.println(user);<br>                &#125;);<br><br>        users.stream().close();<br>    &#125;<br><br>&#125;<br><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> salary;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> age, <span class="hljs-keyword">int</span> salary)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.age = age;<br>        <span class="hljs-keyword">this</span>.salary = salary;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getSalary</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> salary;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSalary</span><span class="hljs-params">(<span class="hljs-keyword">int</span> salary)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.salary = salary;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, salary=&quot;</span> + salary +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br>User&#123;name=<span class="hljs-string">&#x27;william1&#x27;</span>, age=<span class="hljs-number">18</span>, salary=<span class="hljs-number">10000</span>&#125;<br>User&#123;name=<span class="hljs-string">&#x27;william2&#x27;</span>, age=<span class="hljs-number">19</span>, salary=<span class="hljs-number">11000</span>&#125;<br>User&#123;name=<span class="hljs-string">&#x27;william3&#x27;</span>, age=<span class="hljs-number">20</span>, salary=<span class="hljs-number">12000</span>&#125;<br>User&#123;name=<span class="hljs-string">&#x27;william4&#x27;</span>, age=<span class="hljs-number">21</span>, salary=<span class="hljs-number">13000</span>&#125;<br>User&#123;name=<span class="hljs-string">&#x27;william5&#x27;</span>, age=<span class="hljs-number">22</span>, salary=<span class="hljs-number">14000</span>&#125;<br>User&#123;name=<span class="hljs-string">&#x27;william6&#x27;</span>, age=<span class="hljs-number">23</span>, salary=<span class="hljs-number">15000</span>&#125;<br>---------我是分割线--------<br>User&#123;name=<span class="hljs-string">&#x27;william4&#x27;</span>, age=<span class="hljs-number">21</span>, salary=<span class="hljs-number">13000</span>&#125;<br>User&#123;name=<span class="hljs-string">&#x27;william5&#x27;</span>, age=<span class="hljs-number">22</span>, salary=<span class="hljs-number">14000</span>&#125;<br>User&#123;name=<span class="hljs-string">&#x27;william6&#x27;</span>, age=<span class="hljs-number">23</span>, salary=<span class="hljs-number">15000</span>&#125;<br><span class="hljs-number">12000</span><br><span class="hljs-number">13000</span><br><span class="hljs-number">14000</span><br><span class="hljs-number">15000</span><br><span class="hljs-number">16000</span><br><span class="hljs-number">17000</span><br><br>进程已结束，退出代码为 <span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure>



<h2 id="Fork-Join分支合并"><a href="#Fork-Join分支合并" class="headerlink" title="Fork/Join分支合并"></a>Fork/Join分支合并</h2><p>ork/Join框架是一个实现了ExecutorService接口的多线程处理器，它专为那些可以通过递归分解成更细小的任务而设计，最大化的利用多核处理器来提高应用程序的性能。</p>
<p>与其他ExecutorService相关的实现相同的是，Fork/Join框架会将任务分配给线程池中的线程。而与之不同的是，Fork/Join框架在执行任务时使用了<strong>工作窃取算法</strong>。</p>
<p><strong>fork</strong>在英文里有分叉的意思，<strong>join</strong>在英文里连接、结合的意思。顾名思义，fork就是要使一个大任务分解成若干个小任务，而join就是最后将各个小任务的结果结合起来得到大任务的结果。</p>
<p><img src="https://img.mercuryblog.site/img/image-20221017132505169.png" srcset="/img/newloading.gif" lazyload alt="image-20221017132505169"></p>
<p>感觉就是分治算法的思想</p>
<p>工作窃取算法指的是在多线程执行不同任务队列的过程中，某个线程执行完自己队列的任务后从其他线程的任务队列里窃取任务来执行。</p>
<p>工作窃取流程如下图所示：</p>
<p><img src="https://img.mercuryblog.site/img/image-20221017132535148.png" srcset="/img/newloading.gif" lazyload></p>
<h2 id="异步回调"><a href="#异步回调" class="headerlink" title="异步回调"></a>异步回调</h2><ul>
<li><p>类似ajax技术，可以进行异步执行、成功回调、失败回调。</p>
</li>
<li><p>java.util.concurrent包下的 接口Future<V>，有</p>
<ul>
<li>实现子类：CompletableFuture ， CountedCompleter ， ForkJoinTask ， FutureTask ， RecursiveAction ， RecursiveTask ， SwingWorker</li>
</ul>
</li>
<li><p>CompletableFuture 有静态方法</p>
<p>  无返回结果</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20210713165237808.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI0NjU0NTAx,size_16,color_FFFFFF,t_70" srcset="/img/newloading.gif" lazyload></p>
<p>​      有返回结果</p>
<p><img src="https://img-blog.csdnimg.cn/20210713165403816.png" srcset="/img/newloading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br><br>        test2();<br><br>    &#125;<br><br>    <span class="hljs-comment">// 1. 无返回值的 异步</span><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>  <span class="hljs-title">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>        CompletableFuture&lt;Void&gt;  completableFuture =  CompletableFuture.runAsync(()-&gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);<br>                System.out.println(<span class="hljs-string">&quot;异步任务执行了！！&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>            &#125;<br>        &#125;);<br><br>        System.out.println(<span class="hljs-string">&quot;willaim1&quot;</span>);<br>        completableFuture.get();<br><br><br>    &#125;<br><br>    <span class="hljs-comment">// 2. 有返回值的 异步</span><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>  <span class="hljs-title">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>        CompletableFuture&lt;Integer&gt;  completableFuture =  CompletableFuture.supplyAsync(()-&gt;&#123;<br>            <span class="hljs-keyword">int</span> num = <span class="hljs-number">10</span> / <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br><br><br>                TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;);<br><br><br>        System.out.println(<span class="hljs-string">&quot;william2&quot;</span>);<br><br>        completableFuture.whenCompleteAsync((t,u)-&gt;&#123;<br>            System.out.println(t+<span class="hljs-string">&quot;=====&gt; &quot;</span> + t); <span class="hljs-comment">// 成功的时候返回值</span><br>            System.out.println(u+<span class="hljs-string">&quot;=====&gt; &quot;</span> + u); <span class="hljs-comment">// 失败的信息</span><br>            System.out.println(<span class="hljs-string">&quot;有返回值的异步执行了！&quot;</span>);<br><br>        &#125;).exceptionally((e)-&gt;&#123; <span class="hljs-comment">// 异常捕获</span><br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">404</span>;<br>        &#125;).get();<br><br><br><br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>



<h2 id="JMM"><a href="#JMM" class="headerlink" title="JMM"></a>JMM</h2><p>JMM：Java内存模型，是一个概念,不是实际存在的东西</p>
<ul>
<li>线程解锁前，必须把 共享变量 立刻 刷新为主存（每个线程都有自己一块内存称为 工作内存，操作的变量是自己内存块的变量，但是实际存在的位置是主存，因此每次操作完之后需要 更新 主存）</li>
<li>线程加锁前：必须读取主存中的最新值搭配线程工作内存中</li>
</ul>
<p>JMM的八种操作</p>
<ul>
<li>read、load</li>
<li>use、assign</li>
<li>write、store</li>
<li>lock、unlock</li>
</ul>
<ol>
<li>lock(锁定)，作用于主内存中的变量，把变量标识为线程独占的状态。</li>
<li>read(读取)，作用于主内存的变量，把变量的值从主内存传输到线程的工作内存中，以便下一步的load操作使用。</li>
<li>load(加载)，作用于工作内存的变量，把read操作主存的变量放入到工作内存的变量副本中。</li>
<li>use(使用)，作用于工作内存的变量，把工作内存中的变量传输到执行引擎，每当虚拟机遇到一个需要使用到变量的值的字节码指令时将会执行这个操作。</li>
<li>assign(赋值)，作用于工作内存的变量，它把一个从执行引擎中接受到的值赋值给工作内存的变量副本中，每当虚拟机遇到一个给变量赋值的字节码指令时将会执行这个操作。</li>
<li>store(存储)，作用于工作内存的变量，它把一个从工作内存中一个变量的值传送到主内存中，以便后续的write使用。</li>
<li>write(写入)：作用于主内存中的变量，它把store操作从工作内存中得到的变量的值放入主内存的变量中。</li>
<li>unlock(解锁)：作用于主内存的变量，它把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定。</li>
</ol>
<h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><h3 id="保证可见性"><a href="#保证可见性" class="headerlink" title="保证可见性"></a>保证可见性</h3><p><strong>内存可见性，指的是线程之间的可见性，当一个线程修改了共享变量时，另一个线程可以读取到这个修改后的值</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo1_volatile</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span>  Boolean flag = <span class="hljs-keyword">true</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">while</span>(flag)&#123;<br><br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;其他线程&quot;</span>).start();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;主线程修改了flag,但是另外一个线程工作空间的flag仍然是true.&quot;</span>);<br>        flag = <span class="hljs-keyword">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>若不加volatile 该程序会一直死循环，因为内存不可见，可以通过修改flag为<code>private static volatile Boolean flag = true;</code>  即加上volatile保证内存可见性解决问题</p>
<h3 id="不保证原子性"><a href="#不保证原子性" class="headerlink" title="不保证原子性"></a>不保证原子性</h3><p>原子性即是不可分割性，通俗的讲就是线程A在执行的时候不可打扰 要么成功 要么失败</p>
<p>可以使用原子类来解决原子性的问题  比如原子性的integer类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VolatileDemo2</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> num = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i1 = <span class="hljs-number">0</span>; i1 &lt; <span class="hljs-number">1000</span>; i1++) &#123;<br>                    add();<br>                &#125;<br>            &#125;).start();<br>        &#125;<br><br>        <span class="hljs-comment">// 确保上面的线程执行完，只剩下 main 和 gc 线程</span><br>        <span class="hljs-keyword">while</span>(Thread.activeCount() &gt; <span class="hljs-number">2</span>)&#123;<br>            Thread.yield();<span class="hljs-comment">//当前主线程 暂时停止执行</span><br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;正常结果为100，输出结果为===》&quot;</span> + num); <span class="hljs-comment">// 正常结果为10000，输出结果为===》9991</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span>&#123;<br>        num++;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以通过加上synchronzied关键字或者Lock锁来保证原子性</p>
<p>或者另外一种方式 使用原子类来解决</p>
<p>创建 可原子更新的int 值对象</p>
<p><code>private static volatile AtomicInteger num = new AtomicInteger(0);</code></p>
<p>该对象有方法+1，原理是调用Unsafe类的方法，底层使用的CAS<br><code>num.getAndIncrement();</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicDemo3</span> </span>&#123;<br><br>    <span class="hljs-comment">// 创建 可原子更新的int 值对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> AtomicInteger num = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i1 = <span class="hljs-number">0</span>; i1 &lt; <span class="hljs-number">1000</span>; i1++) &#123;<br>                    <span class="hljs-comment">// 该对象有方法+1，底层使用的CAS</span><br>                    num.getAndIncrement();<br>                &#125;<br>            &#125;).start();<br>        &#125;<br><br>        <span class="hljs-comment">// 确保上面的线程执行完，只剩下 main 和 gc 线程</span><br>        <span class="hljs-keyword">while</span>(Thread.activeCount() &gt; <span class="hljs-number">2</span>)&#123;<br>            Thread.yield();<span class="hljs-comment">//当前主线程 暂时停止执行</span><br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;正常结果为10000，输出结果为===》&quot;</span> + num); <span class="hljs-comment">// 正常结果为10000，输出结果为===》10000</span><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="禁止指令重排"><a href="#禁止指令重排" class="headerlink" title="禁止指令重排"></a>禁止指令重排</h3><p>指令重排 ，简单的来说就是计算机将你的指令优化了一下，以最高效的顺序执行</p>
<p>源代码 ==&gt; 编译器优化的重排 ==&gt; 指令并行也可能重排 ==&gt; 内存系统也会重排 执行</p>
<p>指令重排有个前提，他会考虑数据之间的依赖性，如果没有影响才会进行指令重排 </p>
<p>加入volatile会避免指令重排，内存中有屏障，作用</p>
<ul>
<li>保证特定的执行顺序</li>
<li>可以保证某些变量的内存可见性</li>
</ul>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式是Java中最简单的设计模式之一，这种模式涉及一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建，这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象</p>
<p>注意</p>
<ul>
<li>单例类只能有一个实例</li>
<li>单例类必须自己创建自己的唯一实例</li>
<li>单例类必须给所有其他的对象提供这一实例</li>
</ul>
<h3 id="饿汉式单例"><a href="#饿汉式单例" class="headerlink" title="饿汉式单例"></a>饿汉式单例</h3><p>多线程下特点</p>
<ul>
<li>这种方式比较常用，但容易产生垃圾对象。私有构造器，开始直接创建实例被加载进内存。 容易造成内存空间的浪费</li>
<li>优点：没有加锁，执行效率会提高。</li>
<li>缺点：类加载时就初始化，浪费内存。</li>
<li>它基于 classloader 机制避免了多线程的同步问题，不过，instance 在类装载时就实例化，虽然导致类装载的原因有很多种，在单例模式中大多数都是调用 getInstance 方法， 但是也不能确定有其他的方式（或者其他的静态方法）导致类装载，这时候初始化 instance 显然没有达到 lazy loading 的效果。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo1_hungry</span> </span>&#123;<br><br>    <span class="hljs-comment">// 因为是getInstance是静态方法，因此开始就被加载进内存，因此有可能会浪费内存空间</span><br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">byte</span>[] data1 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>* <span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">byte</span>[] data2 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>* <span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">byte</span>[] data3 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>* <span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">byte</span>[] data4 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>* <span class="hljs-number">1024</span>];<br><br>    <span class="hljs-comment">//注意 这里是私有的构造方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Demo1_hungry</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Demo1_hungry hungryMan = <span class="hljs-keyword">new</span> Demo1_hungry();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Demo1_hungry <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> hungryMan;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="懒汉式单例"><a href="#懒汉式单例" class="headerlink" title="懒汉式单例"></a>懒汉式单例</h3><p><strong>一般懒汉式</strong></p>
<p>特点</p>
<ul>
<li><p>需要使用单例时，单例才初始化占用内存。</p>
</li>
<li><p>单线程下没问题，但是线程下是不安全的，会出现多个实例。</p>
</li>
<li><p>这种方式是最基本的实现方式，这种实现最大的问题就是不支持多线程。因为没有加锁 synchronized，所以严格意义上它并不算单例模式。<br>这种方式 lazy loading 很明显，不要求线程安全，在多线程不能正常工作。</p>
</li>
</ul>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2_lazy</span> </span>&#123;<br> <br>     <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Demo2_lazy lazyMan;<br> <br>     <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Demo2_lazy</span><span class="hljs-params">()</span></span>&#123;<br>         System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;线程拿到了实例！&quot;</span>);<br>     &#125;<br> <br>     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  Demo2_lazy <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>         <span class="hljs-comment">//需要使用单例的情况下 且实例没有被创建 才创建单例</span><br>         <span class="hljs-keyword">if</span>(lazyMan == <span class="hljs-keyword">null</span>)&#123;<br>             <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> Demo2_lazy();<br>         &#125;<br>         <span class="hljs-keyword">return</span> lazyMan;<br>     &#125;<br> <br>     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>         <span class="hljs-comment">//模拟线程拿到实例</span><br>         <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>             <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                 Demo2_lazy.getInstance();<br>             &#125;,String.valueOf(i)).start();<br>         &#125;<br>     &#125;<br> &#125;<br><br><span class="hljs-comment">//输出</span><br><span class="hljs-number">0</span>线程拿到了实例！<br><span class="hljs-number">4</span>线程拿到了实例！<br><span class="hljs-number">5</span>线程拿到了实例！<br><span class="hljs-number">3</span>线程拿到了实例！<br><span class="hljs-number">2</span>线程拿到了实例！<br><span class="hljs-number">1</span>线程拿到了实例！<br><span class="hljs-number">7</span>线程拿到了实例！<br><span class="hljs-number">6</span>线程拿到了实例！<br><span class="hljs-number">8</span>线程拿到了实例！<br><span class="hljs-number">9</span>线程拿到了实例！<br><br><span class="hljs-comment">//很明显不能保证一个单例</span><br></code></pre></td></tr></table></figure>

<p> <strong>加锁懒汉式</strong></p>
<p>特点</p>
<ul>
<li>相比一般的懒汉式，在获取实例的静态方法前加synchronized关键字，可以保证多线程之间的同步问题，保证单例模式</li>
<li>这种方式具备很好的 lazy loading，能够在多线程中很好的工作，但是，效率很低，99% 情况下不需要同步。</li>
<li>优点：第一次调用才初始化，避免内存浪费。</li>
<li>缺点：必须加锁 synchronized 才能保证单例，但加锁会影响效率。getInstance() 的性能对应用程序不是很关键（该方法使用不太频繁）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo3_sychronziedLazyMan</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Demo3_sychronziedLazyMan lazyMan;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Demo3_sychronziedLazyMan</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;线程拿到了实例！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Demo3_sychronziedLazyMan <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//需要使用单例的情况下 且实例没有被创建 才创建单例</span><br>        <span class="hljs-keyword">if</span>(lazyMan == <span class="hljs-keyword">null</span>)&#123;<br>            lazyMan = <span class="hljs-keyword">new</span> Demo3_sychronziedLazyMan();<br>        &#125;<br>        <span class="hljs-keyword">return</span> lazyMan;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//模拟线程拿到实例</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                Demo3_sychronziedLazyMan.getInstance();<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br><span class="hljs-number">0</span>线程拿到了实例！<br>    <br><span class="hljs-comment">//只有一个线程拿到了实例</span><br></code></pre></td></tr></table></figure>



<h3 id="DCL双重校验锁"><a href="#DCL双重校验锁" class="headerlink" title="DCL双重校验锁"></a>DCL双重校验锁</h3><p>特点</p>
<ul>
<li>DCL即 double-checked locking</li>
<li>相比一般懒汉式，又加了一层 if(实例还不存在) { synchronized (单例类) { if(实力还不存在） 初始化单例} }, volatile关键字 保证线程之间的同步问题</li>
<li>相比加锁的懒汉式，不是在方法前面加synchronized从而影响效率，这种方法效率更高。<br>这种方式采用双锁机制，安全且在多线程情况下能保持高性能。 getInstance() 的性能对应用程序很关键。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo4_DCLLazyMan</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Demo4_DCLLazyMan lazyMan;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Demo4_DCLLazyMan</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 线程拿到了实例！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Demo4_DCLLazyMan <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//第一次判断，没有实例的时候给类加锁</span><br>        <span class="hljs-keyword">if</span>(lazyMan == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">synchronized</span> (Demo4_DCLLazyMan.class)&#123;<br><br>                <span class="hljs-comment">//第二次判断，没有实例的时候 获得单例</span><br>                <span class="hljs-keyword">if</span>(lazyMan == <span class="hljs-keyword">null</span>)&#123;<br>                    lazyMan = <span class="hljs-keyword">new</span> Demo4_DCLLazyMan();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> lazyMan;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//模拟线程拿到实例</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                Demo3_sychronziedLazyMan.getInstance();<br>            &#125;,String.valueOf(i)).start();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br><span class="hljs-number">0</span>线程拿到了实例！<br></code></pre></td></tr></table></figure>

<p>但是上面的<code>lazyMan = new Demo4_DCLLazyMan();</code>依然有一定的缺陷，在JMM中并不是原子操作，创建实例的过程大致分为三个步骤</p>
<ul>
<li>分配内存空间</li>
<li>执行构造方法</li>
<li>将实例变量指向内存空间</li>
</ul>
<p>而在多线程执行时候，最后两步是可以变的，而这就可能导致多线程同步异常，获取单例失败，因此可以通过使用volatile关键字禁止指令重排解决常见操作非原子性的问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//所以可以将上述代码改为</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Demo4_DCLLazyMan lazyMan;<br></code></pre></td></tr></table></figure>





<h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><p>概念</p>
<ul>
<li>CAS（Compare-and-Swap），即比较并替换，是一种实现并发算法时常用到的技术，Java并发包中的很多类都使用了CAS技术。</li>
<li>CAS也是现在面试经常问的问题<br>之前学习的java.util.concurrent.automics下的AtomicsInteger等类提供简单的cas操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo1_CAS</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        AtomicInteger num  = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">100</span>);<br>        <span class="hljs-comment">//期望 更新</span><br>        <span class="hljs-comment">//如果期望的值达到了就跟新 否则不更新</span><br>        num.compareAndSet(<span class="hljs-number">100</span>,<span class="hljs-number">101</span>);<br>        System.out.println(num.compareAndSet(<span class="hljs-number">101</span>, <span class="hljs-number">120</span>));<span class="hljs-comment">//true</span><br>        System.out.println(num.compareAndSet(<span class="hljs-number">150</span>, <span class="hljs-number">130</span>));<span class="hljs-comment">//false</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>而Java实现CAS的功能使用的依然是我们熟悉的Unsafe类</p>
<h3 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h3><p>ABA问题即是狸猫换太子，也就是一个线程速度过快，在正常线程1，2之间穿插了一个捣乱的线程，但是捣乱线程的操作会使 数据恢复为未执行之前的状态，故不会影响正常线程执行结果，一般情况下ABA并不会出现什么问题，但是设计引用的时候就会出现问题。</p>
<p><strong>通过原子引用来解决ABA问题</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABA</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AtomicStampedReference&lt;Integer&gt; num = <span class="hljs-keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-comment">//线程2 期望的版本号</span><br>        <span class="hljs-keyword">int</span> currentStamp = num.getStamp();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;=============正常线程1===========&quot;</span>);<br><br>            <span class="hljs-comment">//获得版本号</span><br>            System.out.println(<span class="hljs-string">&quot;正常版本号1 拿到版本号&quot;</span> + num.getStamp());<br>        &#125;,<span class="hljs-string">&quot;正常线程&quot;</span>).start();<br><br>        <span class="hljs-comment">//休眠2s</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-comment">//捣乱的线程不影响正常结果</span><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;=========I AM 捣乱线程==========&quot;</span>);<br>            System.out.println(num.compareAndSet(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,num.getStamp(), num.getStamp() + <span class="hljs-number">1</span>));<br>            System.out.println(<span class="hljs-string">&quot;捣乱线程第一次修改值后的 版本号===》&quot;</span> + num.getStamp());<br>            System.out.println(num.compareAndSet(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, num.getStamp(), num.getStamp() + <span class="hljs-number">1</span>));<br>            System.out.println(<span class="hljs-string">&quot;捣乱线程第二次修改值后的 版本号===》&quot;</span> + num.getStamp());<br>        &#125;,<span class="hljs-string">&quot;捣乱线程&quot;</span>).start();<br><br>        <span class="hljs-comment">//休眠2s</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-comment">//正常线程2</span><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;=============正常线程2===========&quot;</span>);<br><br>            <span class="hljs-comment">//获得版本号</span><br>            System.out.println(<span class="hljs-string">&quot;正常版本号2执行前 当前版本号&quot;</span> + num.getStamp());<br>            System.out.println(<span class="hljs-string">&quot;正常版本号2执行前 期望版本号&quot;</span> + currentStamp);<br>            System.out.println(num.compareAndSet(<span class="hljs-number">1000</span>, <span class="hljs-number">3000</span>, currentStamp, num.getStamp() + <span class="hljs-number">1</span>));<br>            System.out.println(<span class="hljs-string">&quot;正常线程2执行后 版本号===》&quot;</span> + num.getStamp());<br>        &#125;,<span class="hljs-string">&quot;正常线程&quot;</span>).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出</span><br>=============正常线程<span class="hljs-number">1</span>===========<br>正常版本号<span class="hljs-number">1</span> 拿到版本号<span class="hljs-number">1</span><br>=========I AM 捣乱线程==========<br><span class="hljs-keyword">true</span><br>捣乱线程第一次修改值后的 版本号===》<span class="hljs-number">2</span><br><span class="hljs-keyword">true</span><br>捣乱线程第二次修改值后的 版本号===》<span class="hljs-number">3</span><br>=============正常线程<span class="hljs-number">2</span>===========<br>正常版本号<span class="hljs-number">2</span>执行前 当前版本号<span class="hljs-number">3</span><br>正常版本号<span class="hljs-number">2</span>执行前 期望版本号<span class="hljs-number">1</span><br><span class="hljs-keyword">false</span><br>正常线程<span class="hljs-number">2</span>执行后 版本号===》<span class="hljs-number">3</span><br><br>进程已结束，退出代码为 <span class="hljs-number">0</span><br><br></code></pre></td></tr></table></figure>





<h2 id="各种锁"><a href="#各种锁" class="headerlink" title="各种锁"></a>各种锁</h2><h3 id="公平，非公平锁"><a href="#公平，非公平锁" class="headerlink" title="公平，非公平锁"></a>公平，非公平锁</h3><p>概念</p>
<ul>
<li>公平锁：非常公平，线程之间不可以插队</li>
<li>非公平锁：非常不公平，线程之间可以插队(默认）</li>
</ul>
<p>这里的“公平”，其实通俗意义来说就是“先来后到”，也就是FIFO。如果对一个锁来说，先对锁获取请求的线程一定会先被满足，后对锁获取请求的线程后被满足，那这个锁就是公平的。反之，那就是不公平的。</p>
<p>一般情况下，<strong>非公平锁能提升一定的效率。但是非公平锁可能会发生线程饥饿（有一些线程长时间得不到锁）的情况</strong>。所以要根据实际的需求来选择非公平锁和公平锁。</p>
<p>ReentrantLock支持非公平锁和公平锁两种。</p>
<h3 id="乐观锁与悲观锁"><a href="#乐观锁与悲观锁" class="headerlink" title="乐观锁与悲观锁"></a>乐观锁与悲观锁</h3><p><strong>悲观锁：</strong></p>
<p>悲观锁就是我们常说的锁。对于悲观锁来说，它总是认为每次访问共享资源时会发生冲突，所以必须对每次数据操作加上锁，以保证临界区的程序同一时间只能有一个线程在执行。</p>
<p><strong>乐观锁：</strong></p>
<p>乐观锁又称为“无锁”，顾名思义，它是乐观派。乐观锁总是假设对共享资源的访问没有冲突，线程可以不停地执行，无需加锁也无需等待。而一旦多个线程发生冲突，乐观锁通常是使用一种称为CAS的技术来保证线程执行的安全性。</p>
<p>由于无锁操作中没有锁的存在，因此不可能出现死锁的情况，也就是说<strong>乐观锁天生免疫死锁</strong>。</p>
<p>乐观锁多用于“读多写少“的环境，避免频繁加锁影响性能；而悲观锁多用于”写多读少“的环境，避免频繁失败和重试影响性能。</p>
<h3 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h3><p>所谓重入锁，顾名思义。就是支持重新进入的锁，也就是说这个锁支持一个<strong>线程对资源重复加锁</strong>。</p>
<p>synchronized关键字就是使用的重入锁。比如说，你在一个synchronized实例方法里面调用另一个本实例的synchronized实例方法，它可以重新进入这个锁，不会出现任何异常。</p>
<p>如果我们自己在继承AQS实现同步器的时候，没有考虑到占有锁的线程再次获取锁的场景，可能就会导致线程阻塞，那这个就是一个“非可重入锁”。</p>
<p><code>ReentrantLock</code>的中文意思就是可重入锁。</p>
<h3 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h3><p>概述</p>
<ul>
<li>AtomicXxx类下的CAS方法底层就是 自旋锁，不断循环直到成功为止</li>
<li>自旋锁主要应用CAS操作，直到手动释放锁才停止</li>
</ul>
<p>主要就是while啥的，不成功就一直循环</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Atomically updates the current value with the results of</span><br><span class="hljs-comment">    * applying the given function, returning the previous value. The</span><br><span class="hljs-comment">    * function should be side-effect-free, since it may be re-applied</span><br><span class="hljs-comment">    * when attempted updates fail due to contention among threads.</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> updateFunction a side-effect-free function</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span> the previous value</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@since</span> 1.8</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAndUpdate</span><span class="hljs-params">(IntUnaryOperator updateFunction)</span> </span>&#123;<br>       <span class="hljs-keyword">int</span> prev, next;<br>       <span class="hljs-keyword">do</span> &#123;<br>           prev = get();<br>           next = updateFunction.applyAsInt(prev);<br>       &#125; <span class="hljs-keyword">while</span> (!compareAndSet(prev, next));<br>       <span class="hljs-keyword">return</span> prev;<br>   &#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>概念</p>
<ul>
<li>死锁是指两个或两个以上的进程在执行过程中，由于竞争资源或者由于彼此通信而造成的一种阻塞的现象，若无外力作用，它们都将无法推进下去。 此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。</li>
<li>两个线程互相抢夺资源，互相争用还未释放的锁</li>
</ul>
<p>可以使用下面的方法排查死锁</p>
<ul>
<li>使用命令 <code>jps -1</code> 定位进程号</li>
<li>使用<code>jstack 进程号</code> 查看堆栈信息</li>
</ul>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java%E5%B9%B6%E5%8F%91/">#Java并发</a>
      
        <a href="/tags/JUC/">#JUC</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Java并发</div>
      <div>http://example.com/2022/09/14/Java并发/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Mercury</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年9月14日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/19/Netty/" title="Netty">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Netty</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/06/29/leetcodeHot%E6%80%BB%E7%BB%93/" title="leetcodeHot刷题总结">
                        <span class="hidden-mobile">leetcodeHot刷题总结</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        MathJax = {
          tex    : {
            inlineMath: { '[+]': [['$', '$']] }
          },
          loader : {
            load: ['ui/lazy']
          },
          options: {
            renderActions: {
              findScript    : [10, doc => {
                document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                  const display = !!node.type.match(/; *mode=display/);
                  const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                  const text = document.createTextNode('');
                  node.parentNode.replaceChild(text, node);
                  math.start = { node: text, delim: '', n: 0 };
                  math.end = { node: text, delim: '', n: 0 };
                  doc.math.push(math);
                });
              }, '', false],
              insertedScript: [200, () => {
                document.querySelectorAll('mjx-container').forEach(node => {
                  let target = node.parentNode;
                  if (target.nodeName.toLowerCase() === 'li') {
                    target.parentNode.classList.add('has-jax');
                  }
                });
              }, '', false]
            }
          }
        };
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.0/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>

  <!-- 樱花特效 -->
  <script type="text/javascript">
    var windowWidth = $(window).width();
    if (windowWidth > 480) {
      document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
    }
  </script>

</body>
</html>
